# Zig 多模块项目结构说明

## 项目概述

这是一个 Zig 多模块单体仓库（Monorepo）项目，演示了静态链接和动态链接两种不同的应用构建方式。项目包含三个库模块和两个应用模块。

## 项目结构

```
zig-mono/
├── packages/           # 库模块目录
│   ├── common/        # 通用库
│   ├── mathlib/       # 数学功能库
│   └── stringlib/     # 字符串功能库
├── apps/              # 应用模块目录
│   ├── static-app/    # 静态链接应用
│   └── dynamic-app/   # 动态链接应用
├── scripts/           # 构建脚本目录
├── md/                # 文档目录
└── build/             # 编译输出目录（由构建脚本生成）
```

## 模块说明

### 1. Common 通用库

**位置**: `packages/common`

**功能描述**:
- 提供项目中其他模块共用的基础功能
- 包含日志记录器，用于输出带时间戳和前缀的日志信息
- 提供基础工具函数，如字符串大写转换、整数比较等

**主要组件**:
- **Logger**: 日志记录器，支持格式化输出
- **工具函数**: 包括字符串转大写、求最大值、求最小值等

**依赖**: 仅依赖标准库

**C导出层**: `src/cshared.zig` 提供C兼容的接口，用于动态库导出

### 2. MathLib 数学功能库

**位置**: `packages/mathlib`

**功能描述**:
- 提供数学计算相关功能
- 所有计算操作都会通过日志记录器记录执行过程

**主要组件**:
- **Calculator**: 计算器类，提供以下功能
  - 加法运算
  - 乘法运算
  - 阶乘计算
  - 三个数求最大值（使用 common 库的 Max 函数）

**依赖**: 
- common 库（用于日志记录和工具函数）
- 标准库

**C导出层**: `src/cshared.zig` 通过ID映射管理Calculator实例

### 3. StringLib 字符串功能库

**位置**: `packages/stringlib`

**功能描述**:
- 提供字符串处理相关功能
- 所有处理操作都会通过日志记录器记录执行过程

**主要组件**:
- **StringProcessor**: 字符串处理器，提供以下功能
  - 字符串反转
  - 多个字符串连接（可指定分隔符）
  - 字符串转大写（使用 common 库的函数）
  - 统计字符串中的单词数量

**依赖**:
- common 库（用于日志记录和工具函数）
- 标准库

**C导出层**: `src/cshared.zig` 通过ID映射管理StringProcessor实例

### 4. Static-App 静态链接应用

**位置**: `apps/static-app`

**功能描述**:
- 演示应用，使用静态链接方式编译
- 调用三个库的所有主要功能并输出结果
- 直接通过`@import`导入Zig模块

**构建方式**: 
- 所有依赖库的代码会被完全编译到最终的可执行文件中
- 生成单个独立的可执行文件，不需要额外的动态库文件
- 使用`zig build-exe`的`-M`参数指定模块依赖

**依赖**:
- common 库
- mathlib 库
- stringlib 库
- 标准库

### 5. Dynamic-App 动态链接应用

**位置**: `apps/dynamic-app`

**功能描述**:
- 演示应用，使用动态链接方式编译
- 功能与 static-app 完全相同，用于对比两种链接方式的差异
- 通过`extern`声明调用动态库的C接口

**构建方式**:
- 依赖库会先编译成共享库文件（.dylib 或 .so）
- 应用本身编译为可执行文件，运行时动态加载共享库
- 需要共享库文件与可执行文件在正确的路径下
- 使用`-lc`链接C标准库，`-L`和`-l`参数链接动态库

**依赖**:
- common 库（动态链接）
- mathlib 库（动态链接）
- stringlib 库（动态链接）
- C标准库

## 应用功能说明

两个应用执行相同的操作序列：

### 数学运算
1. 执行加法：10 + 20
2. 执行乘法：5 × 7
3. 计算阶乘：5!
4. 求三个数的最大值：Max(15, 8, 23)

### 字符串处理
1. 反转字符串："Hello World"
2. 连接字符串：使用 " - " 连接 "Zig", "Mono", "Project"
3. 转换为大写："zigLang" → "ZIGLANG"
4. 统计单词数："This is a test string"

### 输出
- 详细的日志信息（包括时间戳和模块标识）
- 计算结果摘要表

## 静态链接 vs 动态链接

### 静态链接
- **优点**: 生成单一可执行文件，部署简单，不依赖外部库文件，体积小（76K）
- **缺点**: 多个应用重复包含相同库代码，更新库需要重新编译所有应用

### 动态链接
- **优点**: 可执行文件自身体积较小（55K），多个应用可共享库文件，更新库无需重新编译应用
- **缺点**: 需要管理共享库文件，部署复杂，总体积更大（280K），需要确保库文件路径正确

## 构建说明

项目提供了自动化构建脚本，位于 `scripts/build.sh`，该脚本会：
1. 清理之前的构建产物
2. 创建必要的输出目录
3. 使用`zig build-exe`编译静态链接版本的应用
4. 使用`zig build-lib -dynamic`编译动态链接版本的共享库
5. 使用`zig build-exe -lc`编译动态链接版本的应用
6. 设置正确的运行时库路径（macOS使用`@rpath`）

详细的构建过程和大小对比结果请参见构建测试总结文档。

## 技术要点

### Zig模块系统
- 使用`-M`参数定义模块及其依赖关系
- 主模块（第一个`-M`）是程序的入口点
- 后续模块可以通过`--dep`声明依赖其他模块
- 模块之间通过`@import("module_name")`相互引用

### C兼容层设计
- 每个库的`cshared.zig`文件提供C导出函数
- 使用`export`关键字导出C兼容的函数
- 通过ID映射管理Zig对象实例（避免直接暴露指针）
- C导出层只做数据转换，核心逻辑在原始Zig代码中实现

### 动态库生成
- 使用`zig build-lib -dynamic`生成`.dylib`（macOS）或`.so`（Linux）
- macOS需要使用`install_name_tool`修改rpath为相对路径
- 动态库需要导出C兼容的符号供外部调用

### 代码复用
- **业务逻辑**: 在`packages/*/src/root.zig`中实现
- **静态链接**: 直接通过`@import`使用Zig模块
- **动态链接**: cshared层包装Zig模块，通过extern声明调用

关键：两种方式执行**完全相同**的代码。

### 模块依赖
```
common (基础库)
  ↓
mathlib, stringlib (依赖 common)
  ↓
static-app (@import Zig模块)
dynamic-app (extern调用.dylib)
```
